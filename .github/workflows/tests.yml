name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Nightly run at 2:00 AM 
    - cron: '0 23 * * *'
  workflow_dispatch:

jobs:
  sanity-tests:
    name: 🟢 Sanity Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run sanity tests
      run: |
        pytest tests/ -m sanity -v --html=reports/sanity_report.html --self-contained-html
    
    - name: Upload sanity report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sanity-test-report
        path: reports/sanity_report.html
        retention-days: 30
    
    - name: Notify Slack - Sanity Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "✅ *Sanity Tests PASSED*\n\n📊 *Details:*\n• Repository: ${{ github.repository }}\n• Branch: ${{ github.ref_name }}\n• Commit: ${{ github.sha }}\n• Author: ${{ github.actor }}\n\n🔗 *Links:*\n• [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n• [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        }' ${{ secrets.SLACK_WEBHOOK_SANITY }}
    
    - name: Notify Slack - Sanity Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "❌ *Sanity Tests FAILED*\n\n📊 *Details:*\n• Repository: ${{ github.repository }}\n• Branch: ${{ github.ref_name }}\n• Commit: ${{ github.sha }}\n• Author: ${{ github.actor }}\n\n🔗 *Links:*\n• [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n• [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\n⚠️ *Action Required:* Please check the test failures immediately."
        }' ${{ secrets.SLACK_WEBHOOK_SANITY }}

  nightly-tests:
    name: 🌙 Nightly Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_nightly)
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run all tests
      run: |
        pytest tests/ -v --html=reports/nightly_report.html --self-contained-html
    
    - name: Upload nightly report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nightly-test-report
        path: reports/nightly_report.html
        retention-days: 30
    
    - name: Generate test summary
      if: always()
      run: |
        echo "## 🌙 Nightly Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📅 **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "🔗 **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "🌿 **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📊 **Test Results:** Check the artifacts for detailed HTML report" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify Slack - Nightly Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "✅ *Nightly Tests PASSED*\n\n📊 *Details:*\n• Repository: ${{ github.repository }}\n• Date: $(date)\n• All tests completed successfully\n\n🔗 *Links:*\n• [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n• [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\n🎉 *Great job! All systems are healthy.*"
        }' ${{ secrets.SLACK_WEBHOOK_NIGHTLY }}
    
    - name: Notify Slack - Nightly Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "❌ *Nightly Tests FAILED*\n\n📊 *Details:*\n• Repository: ${{ github.repository }}\n• Date: $(date)\n• Some tests failed during nightly run\n\n🔗 *Links:*\n• [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n• [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\n⚠️ *Action Required:* Please investigate the failures."
        }' ${{ secrets.SLACK_WEBHOOK_NIGHTLY }}

  test-on-demand:
    name: 🎯 Manual Test Run
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run manual tests
      run: |
        pytest tests/ -v --html=reports/manual_report.html --self-contained-html
    
    - name: Upload manual report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: manual-test-report
        path: reports/manual_report.html
        retention-days: 7
        
    - name: Notify Slack - Manual Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "✅ *Manual Tests PASSED*\n\n📊 *Details:*\n• Repository: ${{ github.repository }}\n• Branch: ${{ github.ref_name }}\n• Commit: ${{ github.sha }}\n• Author: ${{ github.actor }}\n\n🔗 *Links:*\n• [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n• [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        }' ${{ secrets.SLACK_WEBHOOK_MANUAL }}
    
    - name: Notify Slack - Manual Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "❌ *Manual Tests FAILED*\n\n📊 *Details:*\n• Repository: ${{ github.repository }}\n• Branch: ${{ github.ref_name }}\n• Commit: ${{ github.sha }}\n• Author: ${{ github.actor }}\n\n🔗 *Links:*\n• [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n• [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\n⚠️ *Action Required:* Please check the test failures immediately."
        }' ${{ secrets.SLACK_WEBHOOK_MANUAL }} 