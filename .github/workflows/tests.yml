name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Nightly run at 2:00 AM 
    - cron: '0 23 * * *'
  workflow_dispatch:

jobs:
  sanity-tests:
    name: ğŸŸ¢ Sanity Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run sanity tests
      run: |
        pytest tests/ -m sanity -v --html=reports/sanity_report.html --self-contained-html
    
    - name: Upload sanity report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sanity-test-report
        path: reports/sanity_report.html
        retention-days: 30
    
    - name: Notify Slack - Sanity Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âœ… *Sanity Tests PASSED*\n\nğŸ“Š *Details:*\nâ€¢ Repository: ${{ github.repository }}\nâ€¢ Branch: ${{ github.ref_name }}\nâ€¢ Commit: ${{ github.sha }}\nâ€¢ Author: ${{ github.actor }}\n\nğŸ”— *Links:*\nâ€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nâ€¢ [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        }' ${{ secrets.SLACK_WEBHOOK_SANITY }}
    
    - name: Notify Slack - Sanity Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âŒ *Sanity Tests FAILED*\n\nğŸ“Š *Details:*\nâ€¢ Repository: ${{ github.repository }}\nâ€¢ Branch: ${{ github.ref_name }}\nâ€¢ Commit: ${{ github.sha }}\nâ€¢ Author: ${{ github.actor }}\n\nğŸ”— *Links:*\nâ€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nâ€¢ [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\nâš ï¸ *Action Required:* Please check the test failures immediately."
        }' ${{ secrets.SLACK_WEBHOOK_SANITY }}

  nightly-tests:
    name: ğŸŒ™ Nightly Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_nightly)
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run all tests
      run: |
        pytest tests/ -v --html=reports/nightly_report.html --self-contained-html
    
    - name: Upload nightly report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nightly-test-report
        path: reports/nightly_report.html
        retention-days: 30
    
    - name: Generate test summary
      if: always()
      run: |
        echo "## ğŸŒ™ Nightly Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸŒ¿ **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“Š **Test Results:** Check the artifacts for detailed HTML report" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify Slack - Nightly Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âœ… *Nightly Tests PASSED*\n\nğŸ“Š *Details:*\nâ€¢ Repository: ${{ github.repository }}\nâ€¢ Date: $(date)\nâ€¢ All tests completed successfully\n\nğŸ”— *Links:*\nâ€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nâ€¢ [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\nğŸ‰ *Great job! All systems are healthy.*"
        }' ${{ secrets.SLACK_WEBHOOK_NIGHTLY }}
    
    - name: Notify Slack - Nightly Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âŒ *Nightly Tests FAILED*\n\nğŸ“Š *Details:*\nâ€¢ Repository: ${{ github.repository }}\nâ€¢ Date: $(date)\nâ€¢ Some tests failed during nightly run\n\nğŸ”— *Links:*\nâ€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nâ€¢ [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\nâš ï¸ *Action Required:* Please investigate the failures."
        }' ${{ secrets.SLACK_WEBHOOK_NIGHTLY }}

  test-on-demand:
    name: ğŸ¯ Manual Test Run
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run manual tests
      run: |
        pytest tests/ -v --html=reports/manual_report.html --self-contained-html
    
    - name: Upload manual report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: manual-test-report
        path: reports/manual_report.html
        retention-days: 7
        
    - name: Notify Slack - Manual Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âœ… *Manual Tests PASSED*\n\nğŸ“Š *Details:*\nâ€¢ Repository: ${{ github.repository }}\nâ€¢ Branch: ${{ github.ref_name }}\nâ€¢ Commit: ${{ github.sha }}\nâ€¢ Author: ${{ github.actor }}\n\nğŸ”— *Links:*\nâ€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nâ€¢ [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        }' ${{ secrets.SLACK_WEBHOOK_MANUAL }}
    
    - name: Notify Slack - Manual Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âŒ *Manual Tests FAILED*\n\nğŸ“Š *Details:*\nâ€¢ Repository: ${{ github.repository }}\nâ€¢ Branch: ${{ github.ref_name }}\nâ€¢ Commit: ${{ github.sha }}\nâ€¢ Author: ${{ github.actor }}\n\nğŸ”— *Links:*\nâ€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nâ€¢ [Download Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\nâš ï¸ *Action Required:* Please check the test failures immediately."
        }' ${{ secrets.SLACK_WEBHOOK_MANUAL }} 